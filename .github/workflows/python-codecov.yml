# ============================================================================
# Reusable Secure Codecov Upload Workflow
# ============================================================================
# Securely uploads coverage reports to Codecov without checking out source code
# This prevents malicious PR code execution (pwn request attacks)
#
# Usage from downstream repos:
#   # First, in your CI workflow, upload coverage as artifact:
#   jobs:
#     test:
#       steps:
#         - run: pytest --cov --cov-report=xml
#         - uses: actions/upload-artifact@v4
#           with:
#             name: coverage-reports
#             path: coverage.xml
#
#   # Then call this workflow:
#   upload-coverage:
#     needs: test
#     uses: ByronWilliamsCPA/.github/.github/workflows/python-codecov.yml@main
#     with:
#       artifact-name: 'coverage-reports'
#     secrets:
#       CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
#
# Security:
#   - Uses workflow_run or artifact-based approach
#   - No source checkout prevents pwn request attacks
#   - See: https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
# ============================================================================

name: Codecov Upload (Reusable)

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Name of the artifact containing coverage reports'
        type: string
        required: false
        default: 'coverage-reports'

      coverage-files:
        description: 'Glob pattern for coverage files within artifact'
        type: string
        required: false
        default: '*.xml'

      flags:
        description: 'Codecov flags (comma-separated)'
        type: string
        required: false
        default: ''

      name:
        description: 'Name for the coverage upload'
        type: string
        required: false
        default: 'coverage'

      fail-ci-if-error:
        description: 'Fail the workflow if Codecov upload fails'
        type: boolean
        required: false
        default: false

      verbose:
        description: 'Enable verbose output'
        type: boolean
        required: false
        default: false

      # For workflow_run triggered uploads
      workflow-run-id:
        description: 'Workflow run ID to download artifacts from (for workflow_run trigger)'
        type: string
        required: false
        default: ''

      commit-sha:
        description: 'Commit SHA to associate with coverage (for workflow_run trigger)'
        type: string
        required: false
        default: ''

    secrets:
      CODECOV_TOKEN:
        description: 'Codecov upload token'
        required: true

permissions:
  contents: read
  actions: read

jobs:
  upload-coverage:
    name: Upload Coverage to Codecov
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      # NOTE: Intentionally NOT checking out repository code
      # This is a security measure to prevent pwn request attacks
      # See: https://securitylab.github.com/research/github-actions-preventing-pwn-requests/

      - name: Download coverage artifact (same workflow)
        if: ${{ inputs.workflow-run-id == '' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: ${{ inputs.artifact-name }}
          path: coverage/

      - name: Download coverage artifact (workflow_run)
        if: ${{ inputs.workflow-run-id != '' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: ${{ inputs.artifact-name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.workflow-run-id }}
          path: coverage/

      - name: List coverage files
        run: |
          echo "Coverage files found:"
          find coverage/ -name "${{ inputs.coverage-files }}" -type f | head -20

      - name: Upload to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # v4.6.0
        with:
          directory: coverage/
          files: ${{ inputs.coverage-files }}
          flags: ${{ inputs.flags }}
          name: ${{ inputs.name }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: ${{ inputs.fail-ci-if-error }}
          verbose: ${{ inputs.verbose }}
          # For workflow_run triggers, specify the commit
          commit_parent: ${{ inputs.commit-sha || github.sha }}

      - name: Coverage Upload Summary
        if: always()
        env:
          GH_REPOSITORY: ${{ github.repository }}
          COVERAGE_FILES: ${{ inputs.coverage-files }}
          CODECOV_FLAGS: ${{ inputs.flags }}
        run: |
          echo "## Codecov Upload Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILE_COUNT=$(find coverage/ -name "$COVERAGE_FILES" -type f | wc -l)
          echo "**Files Uploaded:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ -n "$CODECOV_FLAGS" ]; then
            echo "**Flags:** $CODECOV_FLAGS" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View coverage at: https://app.codecov.io/gh/${GH_REPOSITORY}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Note" >> $GITHUB_STEP_SUMMARY
          echo "This workflow uses artifact-based upload without source checkout to prevent pwn request attacks." >> $GITHUB_STEP_SUMMARY
