# Python Security Analysis - Reusable Workflow
# Comprehensive security scanning with CodeQL, Bandit, Safety, OSV-Scanner, and OWASP
#
# Usage from downstream repos:
#   jobs:
#     security:
#       uses: williaby/.github/.github/workflows/python-security-analysis.yml@main
#       with:
#         source-directory: 'src'
#         fail-on-high: true

name: Python Security Analysis (Reusable)

on:
  workflow_call:
    inputs:
      source-directory:
        description: 'Source code directory to scan'
        type: string
        required: false
        default: 'src'

      python-version:
        description: 'Python version for scanning'
        type: string
        required: false
        default: '3.12'

      fail-on-high:
        description: 'Fail build on HIGH/CRITICAL vulnerabilities'
        type: boolean
        required: false
        default: true

      fail-on-medium:
        description: 'Fail build on MEDIUM vulnerabilities'
        type: boolean
        required: false
        default: false

      run-codeql:
        description: 'Run CodeQL analysis'
        type: boolean
        required: false
        default: true

      run-dependency-review:
        description: 'Run dependency review (PRs only)'
        type: boolean
        required: false
        default: true

      run-bandit:
        description: 'Run Bandit static analysis'
        type: boolean
        required: false
        default: true

      run-safety:
        description: 'Run Safety vulnerability scan'
        type: boolean
        required: false
        default: true

      run-osv:
        description: 'Run OSV Scanner'
        type: boolean
        required: false
        default: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Detect security-relevant changes
  detect-changes:
    name: Detect Security Changes
    runs-on: ubuntu-latest
    outputs:
      security_files: ${{ steps.filter.outputs.security }}
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Check for security-relevant changes
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3.0.2
        with:
          filters: |
            security:
              - '**/*.py'
              - '.github/workflows/**'
              - 'pyproject.toml'
              - 'poetry.lock'
              - 'uv.lock'
              - 'requirements*.txt'

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    if: ${{ inputs.run-codeql }}
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55  # v5.5.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --only main --no-interaction

      - name: Initialize CodeQL
        uses: github/codeql-action/init@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169  # v3.27.5
        with:
          languages: python
          queries: security-extended,security-and-quality
          config: |
            paths:
              - ${{ inputs.source-directory }}
            paths-ignore:
              - tests
              - validation
              - scripts

      - name: Build CodeQL Database
        uses: github/codeql-action/autobuild@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169  # v3.27.5

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169  # v3.27.5
        with:
          category: "/language:python"
          upload: true

  # Dependency Review (PRs only)
  dependency-review:
    name: Dependency Review
    if: ${{ inputs.run-dependency-review && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    needs: detect-changes
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@4081bf99e2866ebe428fc0477b69eb4fcda7220a  # v4.5.0
        with:
          fail-on-severity: moderate
          license-check: true
          comment-summary-in-pr: always
          deny-licenses: GPL-2.0, GPL-3.0

  # Python security scanning (Bandit + Safety)
  python-security:
    name: Python Security Scan
    if: ${{ inputs.run-bandit || inputs.run-safety }}
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55  # v5.5.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --no-interaction

      - name: Bandit Static Analysis
        if: ${{ inputs.run-bandit }}
        run: |
          echo "üîí Running Bandit security analysis..."
          uv run bandit -r ${{ inputs.source-directory }} \
            -f json -o bandit-report.json \
            -c pyproject.toml || true
          uv run bandit -r ${{ inputs.source-directory }} -c pyproject.toml

      - name: Safety Vulnerability Scan
        if: ${{ inputs.run-safety }}
        run: |
          echo "üõ°Ô∏è Scanning dependencies for vulnerabilities..."
          pip install poetry-plugin-export
          poetry export -f requirements.txt --output requirements-scan.txt
          uv run safety check \
            --file requirements-scan.txt \
            --json --output safety-report.json || true
          uv run safety check --file requirements-scan.txt

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-report.json
            requirements-scan.txt

  # OSV Scanner
  osv-scanner:
    name: OSV Vulnerability Scanner
    if: ${{ inputs.run-osv }}
    runs-on: ubuntu-latest
    needs: detect-changes
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Run OSV Scanner
        uses: google/osv-scanner-action/osv-scanner-action@9bb69575e74019c2ad085a1860787043adf47ccb  # v2.2.4
        with:
          scan-args: |-
            --lockfile=poetry.lock
            --format=json
            --output=osv-results.json

      - name: Analyze OSV Results
        run: |
          echo "üîç Analyzing OSV scan results..."
          python3 << 'EOF'
          import json
          import sys

          def extract_severity(vuln):
              """Extract severity from various possible locations in vulnerability data."""
              # Check direct severity field
              severity = vuln.get('severity')
              if severity:
                  return 'MEDIUM' if str(severity).upper() == 'MODERATE' else str(severity).upper()

              # Check database_specific
              db_specific = vuln.get('database_specific', {})
              if isinstance(db_specific, dict):
                  severity = db_specific.get('severity')
                  if severity:
                      return 'MEDIUM' if str(severity).upper() == 'MODERATE' else str(severity).upper()

              # Check severities array
              severities = vuln.get('severities', [])
              if isinstance(severities, list) and severities:
                  severity_levels = {'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'MODERATE': 2, 'LOW': 1}
                  max_severity = 'UNKNOWN'
                  max_level = 0
                  for sev_entry in severities:
                      sev = sev_entry.get('severity', '').upper() if isinstance(sev_entry, dict) else str(sev_entry).upper()
                      level = severity_levels.get(sev, 0)
                      if level > max_level:
                          max_level = level
                          max_severity = sev
                  return 'MEDIUM' if max_severity == 'MODERATE' else max_severity

              return 'UNKNOWN'

          try:
              with open('osv-results.json', 'r') as f:
                  results = json.load(f)

              vulnerabilities = results.get('results', [])
              print(f'üìã Found {len(vulnerabilities)} vulnerability groups')

              if not vulnerabilities:
                  print('‚úÖ No vulnerabilities found')
                  sys.exit(0)

              high_crit = []
              medium = []
              low = []

              for vuln_group in vulnerabilities:
                  if not isinstance(vuln_group, dict):
                      continue
                  for pkg in vuln_group.get('packages', []):
                      if not isinstance(pkg, dict):
                          continue
                      for vuln in pkg.get('vulnerabilities', []):
                          if not isinstance(vuln, dict):
                              continue
                          severity = extract_severity(vuln)
                          vuln_id = vuln.get('id', 'UNKNOWN')
                          if severity in ['HIGH', 'CRITICAL']:
                              high_crit.append(f"{vuln_id} ({severity})")
                          elif severity == 'MEDIUM':
                              medium.append(f"{vuln_id} ({severity})")
                          else:
                              low.append(f"{vuln_id} ({severity})")

              total = len(high_crit) + len(medium) + len(low)
              print(f'\nüìä OSV Results: {total} total vulnerabilities')

              if high_crit:
                  print(f'‚ùå HIGH/CRITICAL: {len(high_crit)} vulnerabilities')
                  for v in high_crit[:5]:
                      print(f'   - {v}')
                  if '${{ inputs.fail-on-high }}' == 'true':
                      print('\n‚ùå Build FAILED: HIGH/CRITICAL vulnerabilities found')
                      sys.exit(1)

              if medium:
                  print(f'‚ö†Ô∏è  MEDIUM: {len(medium)} vulnerabilities')
                  if '${{ inputs.fail-on-medium }}' == 'true':
                      print('\n‚ùå Build FAILED: MEDIUM vulnerabilities found')
                      sys.exit(1)

              if low:
                  print(f'‚ÑπÔ∏è  LOW: {len(low)} vulnerabilities')

              if not high_crit:
                  print('\n‚úÖ No HIGH/CRITICAL vulnerabilities found')

          except Exception as e:
              print(f'‚ùå ERROR: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF

      - name: Upload OSV Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: osv-scanner-results
          path: osv-results.json

  # Security gate
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [detect-changes, codeql, dependency-review, python-security, osv-scanner]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Validate Security Results
        run: |
          echo "üîí Security Analysis Results:"
          echo "CodeQL: ${{ needs.codeql.result }}"
          echo "Dependency Review: ${{ needs.dependency-review.result }}"
          echo "Python Security: ${{ needs.python-security.result }}"
          echo "OSV Scanner: ${{ needs.osv-scanner.result }}"

          is_acceptable() {
            [[ "$1" == "success" || "$1" == "skipped" ]]
          }

          if is_acceptable "${{ needs.codeql.result }}" && \
             is_acceptable "${{ needs.dependency-review.result }}" && \
             is_acceptable "${{ needs.python-security.result }}" && \
             is_acceptable "${{ needs.osv-scanner.result }}"; then
            echo "‚úÖ Security gate passed"
            echo "üîê All security checks completed successfully"
          else
            echo "‚ùå Security gate failed - review security scan results"
            exit 1
          fi
