# ============================================================================
# Reusable SLSA Provenance Workflow
# ============================================================================
# Generates SLSA Level 3 provenance attestations for Python packages
#
# Usage from downstream repos:
#   jobs:
#     build:
#       # First build your package and output base64-encoded hashes
#       outputs:
#         hashes: ${{ steps.hash.outputs.hashes }}
#       steps:
#         - uses: actions/checkout@v4
#         - run: pip install build && python -m build
#         - id: hash
#           run: |
#             cd dist && echo "hashes=$(sha256sum * | base64 -w0)" >> "$GITHUB_OUTPUT"
#         - uses: actions/upload-artifact@v4
#           with:
#             name: dist
#             path: dist/
#
#     provenance:
#       needs: build
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-slsa.yml@main
#       with:
#         base64-subjects: ${{ needs.build.outputs.hashes }}
#       permissions:
#         actions: read
#         id-token: write
#         contents: write
#
# Features:
#   - SLSA Level 3 provenance generation
#   - Supply chain security attestations
#   - Automatic release artifact attachment
# ============================================================================

name: SLSA Provenance (Reusable)

on:
  workflow_call:
    inputs:
      base64-subjects:
        description: 'Base64-encoded SHA256 hashes of artifacts (sha256sum * | base64 -w0)'
        type: string
        required: true

      upload-assets:
        description: 'Upload provenance to GitHub Release'
        type: boolean
        required: false
        default: true

      upload-tag-name:
        description: 'Tag name for release upload (defaults to github.ref_name)'
        type: string
        required: false
        default: ''

      provenance-name:
        description: 'Name for the provenance file'
        type: string
        required: false
        default: 'multiple.intoto.jsonl'

permissions:
  actions: read
  id-token: write
  contents: write

jobs:
  provenance:
    name: Generate SLSA Provenance
    # Use the official SLSA generator
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: ${{ inputs.base64-subjects }}
      upload-assets: ${{ inputs.upload-assets }}
      upload-tag-name: ${{ inputs.upload-tag-name || github.ref_name }}
      provenance-name: ${{ inputs.provenance-name }}
