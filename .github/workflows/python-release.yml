# ============================================================================
# Reusable Python Release Workflow
# ============================================================================
# Builds signed releases with SLSA provenance, SBOM generation, and semantic versioning
#
# Usage from downstream repos:
#   jobs:
#     release:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-release.yml@main
#       with:
#         python-version: '3.12'
#         semantic-release: true
#         pypi-package-name: 'my-package'
#       permissions:
#         contents: write
#         id-token: write
#         attestations: write
#
# Features:
#   - Pre-release testing
#   - Semantic versioning with python-semantic-release
#   - Manual release mode (tag-based)
#   - PyPI publishing with OIDC trusted publishing
#   - Sigstore artifact signing
#   - SBOM generation
# ============================================================================

name: Python Release (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      coverage-threshold:
        description: 'Minimum code coverage percentage for pre-release tests'
        required: false
        type: number
        default: 80
      source-directory:
        description: 'Source code directory'
        required: false
        type: string
        default: 'src'
      semantic-release:
        description: 'Use semantic release (true) or manual tag-based (false)'
        required: false
        type: boolean
        default: true
      force-release:
        description: 'Force release type (empty for auto)'
        required: false
        type: string
        default: ''
      publish-to-pypi:
        description: 'Publish to PyPI after release'
        required: false
        type: boolean
        default: true
      pypi-package-name:
        description: 'PyPI package name'
        required: false
        type: string
        default: ''
      pypi-url:
        description: 'PyPI upload URL'
        required: false
        type: string
        default: 'https://upload.pypi.org/legacy/'
      run-tests:
        description: 'Run tests before release'
        required: false
        type: boolean
        default: true
      generate-sbom:
        description: 'Generate Software Bill of Materials'
        required: false
        type: boolean
        default: true
      sign-artifacts:
        description: 'Sign artifacts with Sigstore'
        required: false
        type: boolean
        default: true
    outputs:
      released:
        description: 'Whether a release was created'
        value: ${{ jobs.release.outputs.released }}
      version:
        description: 'The released version'
        value: ${{ jobs.release.outputs.version }}
      tag:
        description: 'The release tag'
        value: ${{ jobs.release.outputs.tag }}

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  attestations: write

jobs:
  # ============================================================================
  # Job 1: Run Tests Before Release
  # ============================================================================
  test:
    name: Pre-Release Tests
    runs-on: ubuntu-latest
    if: inputs.run-tests
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ inputs.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: |
          uv run pytest \
            --cov=${{ inputs.source-directory }} \
            --cov-report=term-missing \
            --cov-fail-under=${{ inputs.coverage-threshold }} \
            -v

      - name: Run type checker
        run: uv run basedpyright ${{ inputs.source-directory }}/

      - name: Run linter
        run: uv run ruff check ${{ inputs.source-directory }}/

  # ============================================================================
  # Job 2: Build and Create Release
  # ============================================================================
  release:
    name: Build & Release
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      released: ${{ steps.semantic-release.outputs.released || steps.manual-release.outputs.released }}
      version: ${{ steps.semantic-release.outputs.version || steps.manual-release.outputs.version }}
      tag: ${{ steps.semantic-release.outputs.tag || steps.manual-release.outputs.tag }}
      hashes: ${{ steps.hash.outputs.hashes }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Set up Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55  # v5.5.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Build package
        run: |
          uv build
          echo "Built packages:"
          ls -lh dist/

      - name: Generate SBOM
        if: inputs.generate-sbom
        run: |
          echo "Generating Software Bill of Materials..."
          pip install cyclonedx-bom==4.6.1
          uv export --format requirements-txt --output-file requirements-all.txt --no-hashes
          cyclonedx-py requirements requirements-all.txt --of json -o dist/sbom.json
          rm -f requirements-all.txt
          echo "SBOM generated: dist/sbom.json"

      - name: Generate artifact hashes
        id: hash
        working-directory: dist
        run: |
          echo "hashes=$(sha256sum * | base64 -w0)" >> "$GITHUB_OUTPUT"

      # Semantic Release Mode
      - name: Python Semantic Release
        if: inputs.semantic-release
        id: semantic-release
        uses: python-semantic-release/python-semantic-release@86e0ab1159fc51ecdc0cc2fb059530b285aab21f  # v9.21.1
        with:
          github_token: ${{ github.token }}
          git_committer_name: "github-actions[bot]"
          git_committer_email: "github-actions[bot]@users.noreply.github.com"
          force: ${{ inputs.force-release }}

      - name: Sign artifacts with Sigstore
        if: inputs.sign-artifacts && (steps.semantic-release.outputs.released == 'true' || !inputs.semantic-release)
        uses: sigstore/gh-action-sigstore-python@f514d46b907ebcd5bedc05145c03b69c1edd8b46  # v3.0.0
        with:
          inputs: ./dist/*.tar.gz ./dist/*.whl
          release-signing-artifacts: true

      - name: Upload to GitHub Release (Semantic)
        if: inputs.semantic-release && steps.semantic-release.outputs.released == 'true'
        uses: python-semantic-release/publish-action@e821354c8e6d662b71478ac398ad3f38cb783692  # v9.21.1
        with:
          github_token: ${{ github.token }}
          tag: ${{ steps.semantic-release.outputs.tag }}

      # Manual Release Mode
      - name: Manual Release
        if: "!inputs.semantic-release"
        id: manual-release
        env:
          TAG_INPUT: ${{ github.event.inputs.tag || github.ref_name }}
        run: |
          TAG="$TAG_INPUT"
          VERSION="${TAG#v}"
          echo "released=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release (Manual)
        if: "!inputs.semantic-release"
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe  # v2.4.2
        with:
          tag_name: ${{ steps.manual-release.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/*.json
            dist/*.sig
            dist/*.crt
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: release-dist
          path: dist/
          retention-days: 5

      - name: Release Summary
        if: steps.semantic-release.outputs.released == 'true' || steps.manual-release.outputs.released == 'true'
        run: |
          VERSION="${{ steps.semantic-release.outputs.version || steps.manual-release.outputs.version }}"
          TAG="${{ steps.semantic-release.outputs.tag || steps.manual-release.outputs.tag }}"
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** $TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Features" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.sign-artifacts }}" == "true" ]; then
            echo "- Sigstore signing: enabled" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.generate-sbom }}" == "true" ]; then
            echo "- SBOM generated: enabled" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- SHA256 hashes: available" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 3: Publish to PyPI
  # ============================================================================
  publish-pypi:
    name: Publish to PyPI
    needs: release
    if: inputs.publish-to-pypi && (needs.release.outputs.released == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: pypi
      url: https://pypi.org/project/${{ inputs.pypi-package-name }}/
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Download artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: release-dist
          path: dist/

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2

      - name: Publish to PyPI
        # Uses trusted publishing (OIDC) - configure at pypi.org/manage/account/publishing/
        run: uv publish --trusted-publishing always dist/*.whl dist/*.tar.gz
        env:
          UV_PUBLISH_URL: ${{ inputs.pypi-url }}

      - name: PyPI Summary
        run: |
          echo "## PyPI Publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Published **${{ inputs.pypi-package-name }}** version **${{ needs.release.outputs.version }}** to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View on PyPI](https://pypi.org/project/${{ inputs.pypi-package-name }}/${{ needs.release.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
