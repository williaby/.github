# Python Documentation - Reusable Workflow
# Builds MkDocs documentation with validation and optional GitHub Pages deployment
#
# Usage from downstream repos:
#   jobs:
#     docs:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-docs.yml@main
#       with:
#         deploy-to-pages: true
#       permissions:
#         contents: read
#         pages: write
#         id-token: write

name: Python Documentation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for building docs'
        type: string
        required: false
        default: '3.12'

      docs-directory:
        description: 'Documentation source directory'
        type: string
        required: false
        default: 'docs'

      source-directory:
        description: 'Source code directory for docstring extraction'
        type: string
        required: false
        default: 'src'

      deploy-to-pages:
        description: 'Deploy to GitHub Pages (main branch only)'
        type: boolean
        required: false
        default: false

      docstring-threshold:
        description: 'Minimum docstring coverage percentage'
        type: number
        required: false
        default: 80

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0  # Full history for git-based dates

      - name: Set up Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55  # v5.5.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Cache dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/uv.lock') }}-docs

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Check docstring coverage
        run: |
          echo "üìù Checking docstring coverage..."
          uv run interrogate ${{ inputs.source-directory }} \
            --fail-under=${{ inputs.docstring-threshold }} \
            --verbose || echo "‚ö†Ô∏è  Docstring coverage below threshold"

      - name: Build MkDocs site
        run: |
          echo "üèóÔ∏è  Building documentation site..."
          uv run mkdocs build --strict --verbose

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: documentation-site
          path: site/
          retention-days: 7

  deploy:
    name: Deploy to GitHub Pages
    if: ${{ inputs.deploy-to-pages && github.ref == 'refs/heads/main' }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: documentation-site
          path: site/

      - name: Setup Pages
        uses: actions/configure-pages@1f0c5cde4bc74cd7e1254d0cb4de8d49e9068c7d  # v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa  # v3
        with:
          path: site/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # v4
