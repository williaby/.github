# ============================================================================
# Reusable REUSE Compliance Workflow
# ============================================================================
# Validates FSFE REUSE 3.0 specification compliance for license management
#
# Usage from downstream repos:
#   jobs:
#     reuse:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-reuse.yml@main
#       with:
#         generate-spdx: true
#
# Features:
#   - FSFE REUSE 3.0 specification compliance checking
#   - SPDX SBOM generation (optional)
#   - License file verification
#   - Copyright header validation
# ============================================================================

name: REUSE Compliance (Reusable)

on:
  workflow_call:
    inputs:
      generate-spdx:
        description: 'Generate SPDX SBOM report'
        type: boolean
        required: false
        default: false

      fail-on-missing:
        description: 'Fail if files are missing licensing information'
        type: boolean
        required: false
        default: true

      artifact-retention-days:
        description: 'Days to retain compliance artifacts'
        type: number
        required: false
        default: 30

permissions:
  contents: read

jobs:
  reuse-compliance:
    name: REUSE Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7  # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Check for required license files
        id: license-check
        run: |
          echo "Checking for required license files..."

          LICENSE_FOUND="false"
          if [ -f "LICENSE" ] || [ -f "LICENSE.txt" ] || [ -f "LICENSE.md" ] || \
             [ -f "COPYING" ] || [ -d "LICENSES" ]; then
            LICENSE_FOUND="true"
            echo "license_found=true" >> $GITHUB_OUTPUT
            echo "License file(s) found"
          else
            echo "license_found=false" >> $GITHUB_OUTPUT
            echo "::warning::No LICENSE file found in repository root"
          fi

      - name: REUSE Compliance Check
        uses: fsfe/reuse-action@3ae3c6bdf1257571f839c91c6d5890047234f0d3  # v4.0.0
        id: reuse
        continue-on-error: ${{ !inputs.fail-on-missing }}

      - name: Generate SPDX SBOM
        if: ${{ inputs.generate-spdx }}
        run: |
          echo "Generating SPDX SBOM..."
          pip install reuse
          reuse spdx -o reuse-spdx.spdx || echo "SPDX generation completed with warnings"

      - name: Upload SPDX artifact
        if: ${{ inputs.generate-spdx }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: reuse-spdx-report
          path: reuse-spdx.spdx
          retention-days: ${{ inputs.artifact-retention-days }}

      - name: REUSE Compliance Summary
        if: always()
        run: |
          echo "## REUSE Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.reuse.outcome }}" == "success" ]; then
            echo "**Status:** Compliant" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All files have proper licensing information according to the REUSE specification." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Non-compliant" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some files are missing licensing information. See workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### How to Fix" >> $GITHUB_STEP_SUMMARY
            echo "1. Add SPDX license identifiers to source files:" >> $GITHUB_STEP_SUMMARY
            echo '   ```' >> $GITHUB_STEP_SUMMARY
            echo '   # SPDX-FileCopyrightText: 2024 Your Name' >> $GITHUB_STEP_SUMMARY
            echo '   # SPDX-License-Identifier: MIT' >> $GITHUB_STEP_SUMMARY
            echo '   ```' >> $GITHUB_STEP_SUMMARY
            echo "2. Or create a \`.reuse/dep5\` file for bulk declarations" >> $GITHUB_STEP_SUMMARY
            echo "3. Install reuse tool: \`pip install reuse\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Run \`reuse lint\` locally to check compliance" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "- [REUSE Specification](https://reuse.software/spec/)" >> $GITHUB_STEP_SUMMARY
          echo "- [REUSE Tutorial](https://reuse.software/tutorial/)" >> $GITHUB_STEP_SUMMARY
          echo "- [SPDX License List](https://spdx.org/licenses/)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.generate-spdx }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "SPDX SBOM generated and uploaded as artifact." >> $GITHUB_STEP_SUMMARY
          fi
